#!/bin/bash
# Session Closer Script
# Run this at the end of each AI session to summarize and commit work
# Can be run manually or called by an AI agent

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Check if we're in a git repo
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}Error: Not in a git repository${NC}"
    echo "This script should be run from a project directory"
    exit 1
fi

PROJECT_NAME=$(basename "$(pwd)")
TIMESTAMP=$(date +"%Y-%m-%d %H:%M")
DATE=$(date +%Y-%m-%d)

echo -e "${YELLOW}Session Closer for: $PROJECT_NAME${NC}"
echo ""

# Check for modified files
if git diff --quiet && git diff --cached --quiet; then
    echo -e "${BLUE}No changes detected. Session already clean.${NC}"
    exit 0
fi

# Show what changed
echo -e "${BLUE}Modified files:${NC}"
git status --short

echo ""
echo -e "${YELLOW}Collecting session summary...${NC}"
echo ""

# Interactive mode - ask for summary
read -p "Session tool used (claude/gemini/opencode/other): " TOOL
read -p "Brief summary of work completed: " WORK_SUMMARY
read -p "Any key decisions made? (optional): " DECISIONS
read -p "Next steps (optional): " NEXT_STEPS

# Build session summary entry
SESSION_ENTRY="## [$TIMESTAMP] - Session

**Tool**: $TOOL

**Work Completed**:
- $WORK_SUMMARY

"

if [ -n "$DECISIONS" ]; then
    SESSION_ENTRY+="**Decisions Made**:
- $DECISIONS

"
fi

# Add modified files list
SESSION_ENTRY+="**Files Modified**:
"
git status --short | while read -r line; do
    SESSION_ENTRY+="- \`$line\`
"
done

if [ -n "$NEXT_STEPS" ]; then
    SESSION_ENTRY+="
**Next Steps**:
- $NEXT_STEPS
"
fi

SESSION_ENTRY+="
**Commit**: [pending]

---

"

# Update session-summary.md
if [ -f "session-summary.md" ]; then
    # Insert after the first ---
    sed -i "/^---$/a\\
$SESSION_ENTRY" session-summary.md
    echo -e "${GREEN}âœ“ session-summary.md updated${NC}"
fi

# Update context sync timestamps
for ctx_file in claude.md gemini.md agents.md; do
    if [ -f "$ctx_file" ]; then
        sed -i "s/Last synced:.*/Last synced: $TIMESTAMP/" "$ctx_file"
        sed -i "s/Synced by:.*/Synced by: session-closer/" "$ctx_file"
    fi
done

echo -e "${GREEN}âœ“ Context files synced${NC}"

# Stage all changes
git add .

# Build commit message
COMMIT_MSG="Session: $WORK_SUMMARY

Date: $DATE
Tool: $TOOL"

if [ -n "$DECISIONS" ]; then
    COMMIT_MSG+="
Decisions: $DECISIONS"
fi

if [ -n "$NEXT_STEPS" ]; then
    COMMIT_MSG+="
Next: $NEXT_STEPS"
fi

COMMIT_MSG+="

ðŸ¤– Session closed with automation"

# Commit
git commit -m "$COMMIT_MSG"
COMMIT_HASH=$(git rev-parse --short HEAD)

echo -e "${GREEN}âœ“ Changes committed: $COMMIT_HASH${NC}"

# Update session-summary.md with commit hash
if [ -f "session-summary.md" ]; then
    sed -i "s/\*\*Commit\*\*: \[pending\]/**Commit**: \`$COMMIT_HASH\`/" session-summary.md
    git add session-summary.md
    git commit --amend --no-edit
    echo -e "${GREEN}âœ“ Commit hash added to summary${NC}"
fi

echo ""
echo -e "${GREEN}Session closed successfully!${NC}"
echo ""
git log -1 --oneline
echo ""
